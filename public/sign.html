<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.2.2/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.2.2/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-database.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-firestore.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-functions.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-messaging.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-storage.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-remote-config.js"></script>
    <script defer src="/__/firebase/8.2.2/firebase-performance.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <!-- Auth imports-->
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css" />

</head>
<body>
<input type="text" id="username"/><input type="button" value="Add" onclick="addData()"/><br>
<div id="users"></div>
<br>
<input type="file" id="filename"/><input type="button" value="Upload" onclick="uploadFile()"/><br>
<div id="files"></div>

<h2>Auth Operations</h2>
<div id="firebaseui-auth-container"></div>
<div id="welcome" style="display: none"></div>
<div id="logout" style="display: none"><input type="button" value="Logout" onclick="logout()"/></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        checkLogin();
    });

    function addData() {
        let username = document.getElementById("username").value;
        firebase.firestore().collection("users")
            .add({
                username: username
            })
            .then(function (docRef) {
                console.log("Document written with ID: ", docRef.id);
            })
            .catch(function (error) {
                console.error("Error adding document: ", error);
            });
    }

    function listenForChanges() {
        firebase.firestore().collection("users")
            .orderBy("username")
            .limit(5)
            .onSnapshot(function (querySnapshot) {
                let users = [];
                querySnapshot.forEach(function (doc) {
                    users.push(doc.data().username);
                });
                document.getElementById("users").innerHTML = users.join("<br>");
            });
    }

    function uploadFile() {
        let file = document.getElementById("filename").files[0];
        console.log("Filename: " + file.name + " size:" + file.size + " type:" + file.type);
        let metadata = {contentType: file.type};
        let uploadTask = firebase.storage().ref().child('images/' + file.name).put(file, metadata);
        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
            function (snapshot) {
                let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                document.getElementById("files").innerHTML = 'Upload is ' + progress + '% done';
            },
            function (error) {
                console.log(error)
            },
            function () {
                uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                    console.log('File available at', downloadURL);
                });
            });
    }

    function listenForFiles() {
        firebase.firestore().collection("images")
            .orderBy("updated", "desc")
            .limit(3)
            .onSnapshot(function (querySnapshot) {
                let files = [];
                querySnapshot.forEach(function (doc) {
                    let file = doc.data();
                    // https://www.googleapis.com/download/storage/v1/b/unipi-aps.appspot.com/o/images%2FuNIPI.jpg?generation=1610549348125433&alt=media
                    // https://firebasestorage.googleapis.com/v0/b/unipi-aps.appspot.com/o/images%2FuNIPI.jpg?alt=media&token=c1a62660-cf1c-4e4f-a8fa-a0baf075d773
                    let url = file.mediaLink.replace(
                        'https://www.googleapis.com/download/storage/v1',
                        'https://firebasestorage.googleapis.com/v0');
                    let html = `<img src='${url}'/><br>${file.name}`
                    files.push(html);
                });
                document.getElementById("files").innerHTML = files.join("<br>");
            });
    }

    function checkLogin() {
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                document.getElementById("welcome").innerHTML = "Welcome " + user.displayName;
                document.getElementById("welcome").style.display = 'block';
                document.getElementById('logout').style.display = 'block';

                listenForChanges();
                listenForFiles();
            } else {
                startAuth();
                document.getElementById("welcome").innerHTML = "";
                document.getElementById("welcome").style.display = 'none';
                document.getElementById('logout').style.display = 'none';
            }
        });
    }

    function logout() {
        firebase.auth().signOut();
    }

    function startAuth() {
        const uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult, redirectUrl) {
                    // User successfully signed in.
                    // Return type determines whether we continue the redirect automatically
                    // or whether we leave that to developer to handle.
                    return true;
                },
                uiShown: function() {
                    // The widget is rendered.
                }
            },
            // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
            signInFlow: 'popup',
            signInSuccessUrl: '.',
            signInOptions: [
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                firebase.auth.EmailAuthProvider.PROVIDER_ID,
            ],
            // Terms of service url.
            tosUrl: '<your-tos-url>',
            // Privacy policy url.
            privacyPolicyUrl: '<your-privacy-policy-url>'
        };

        let ui = new firebaseui.auth.AuthUI(firebase.auth());
        ui.start('#firebaseui-auth-container', uiConfig);
    }

</script>
</body>
</html>
